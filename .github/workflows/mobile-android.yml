name: Test Mobile Wikipedia con Maestro - Android

on:
  workflow_dispatch:

jobs:
  test-wikipedia:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          maestro --version

      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Cache Android AVD
        uses: actions/cache@v3
        with:
          path: |
            ~/.android/avd
            ~/Library/Android/sdk/system-images
          key: ${{ runner.os }}-avd-api29

      # Cache de Flutter SDK
      # Cache Flutter SDK
      - name: Cache Flutter SDK
        uses: actions/cache@v4
        with:
          path: $HOME/flutter
          key: ${{ runner.os }}-flutter-3.24.5
          restore-keys: |
            ${{ runner.os }}-flutter

      # Instalar Flutter (solo si no está en cache)
      - name: Install Flutter SDK
        run: |
          if [ ! -d "$HOME/flutter" ]; then
            echo "Flutter not in cache, cloning..."
            git clone https://github.com/flutter/flutter.git -b stable --depth 1 $HOME/flutter
          else
            echo "Flutter found in cache"
            cd $HOME/flutter
            git pull
          fi
          echo "$HOME/flutter/bin" >> $GITHUB_PATH

      # Cache de dependencias Pub
      - name: Cache Pub packages
        uses: actions/cache@v4
        with:
          path: $HOME/.pub-cache
          key: ${{ runner.os }}-pub-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-pub

      # Cache de Gradle
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: $HOME/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-gradle

      # Configurar Flutter
      - name: Flutter Doctor
        run: |
          $HOME/flutter/bin/flutter doctor -v
          $HOME/flutter/bin/flutter --version
      - name: Iniciar emulador de Android y ejecutar tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          ram-size: 2048M
          disk-size: 4096M
          target: default
          profile: Nexus 6
          script: |
            chmod +x .github/scripts/run_maestro_android.sh
            ./.github/scripts/run_maestro_android.sh

      - name: Subir screenshots como artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-screenshots
          path: maestro-screenshots/
          if-no-files-found: ignore
