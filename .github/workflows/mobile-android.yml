name: Test Mobile Wikipedia con Maestro - Android

on:
  workflow_dispatch:

jobs:
  test-wikipedia:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          maestro --version

      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Cache Android AVD
        uses: actions/cache@v3
        with:
          path: |
            ~/.android/avd
            ~/Library/Android/sdk/system-images
          key: ${{ runner.os }}-avd-api29

      - name: Iniciar emulador de Android y ejecutar tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          ram-size: 2048M
          disk-size: 4096M
          target: default
          profile: Nexus 6
          script: |
            echo "=========================================="
            echo "Emulador iniciado correctamente"
            echo "=========================================="
            adb devices
            adb wait-for-device
            echo "Dispositivo conectado y listo"
            echo ""

            echo "Preparando aplicación desde mobileBuilds/build.apk..."
            echo "APK encontrado en mobileBuilds/build.apk"
            cp mobileBuilds/build.apk wikipedia.apk
            echo "Instalando aplicación..."
            adb install -r wikipedia.apk
            echo "Aplicación instalada correctamente"

            echo ""
            echo "=========================================="
            echo "Ejecutando tests con Maestro"
            echo "=========================================="

            # Asegurar que Maestro esté en el PATH
            export PATH="$PATH:$HOME/.maestro/bin"

            # Verificar que Maestro esté instalado
            maestro --version || echo "Advertencia: Maestro no está disponible"

            # Ejecutar tests con Maestro
            maestro test .maestro/wikipedia-test.yaml --format junit --output maestro-report.xml || true

            echo ""
            echo "=========================================="
            echo "Resultados de las pruebas"
            echo "=========================================="
            echo ""
            echo "Tests ejecutados con Maestro Mobile Test"
            echo "Aplicación: Wikipedia Mobile"
            echo "Fecha: $(date)"
            echo ""
            if [ -f maestro-report.xml ]; then echo "Reporte generado: maestro-report.xml"; cat maestro-report.xml;else echo "No se generó reporte de Maestro"; fi
            echo "=========================================="
