name: Test Mobile Wikipedia con Maestro - Android

on:
  workflow_dispatch:

jobs:
  test-wikipedia:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          maestro --version

      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Cache Android AVD
        uses: actions/cache@v3
        with:
          path: |
            ~/.android/avd
            ~/Library/Android/sdk/system-images
          key: ${{ runner.os }}-avd-api29

      - name: Iniciar emulador de Android y ejecutar tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          ram-size: 2048M
          disk-size: 4096M
          target: default
          profile: Nexus 6
          script: |
            echo "=========================================="
            echo "Emulador iniciado correctamente"
            echo "=========================================="
            adb devices
            adb wait-for-device
            echo "Dispositivo conectado y listo"
            echo ""

            echo "Preparando aplicación desde mobileBuilds/build.apk..."
            echo "APK encontrado en mobileBuilds/build.apk"
            cp mobileBuilds/build.apk wikipedia.apk
            echo "Instalando aplicación..."
            adb install -r wikipedia.apk
            echo "Aplicación instalada correctamente"

            echo ""
            echo "=========================================="
            echo "Ejecutando tests con Maestro"
            echo "=========================================="

            # Asegurar que Maestro esté en el PATH
            export PATH="$PATH:$HOME/.maestro/bin"

            # Verificar que Maestro esté instalado
            maestro --version || echo "Advertencia: Maestro no está disponible"

            # Ejecutar tests con Maestro (con debug y screenshots)
            set +e  # No fallar inmediatamente si Maestro falla
            maestro test .maestro/wikipedia-test.yaml \
              --format junit \
              --output maestro-report.xml \
              --debug \
              --screenshot-on-failure
            MAESTRO_EXIT_CODE=$?
            set -e  # Volver a activar el modo estricto

            echo ""
            echo "=========================================="
            echo "Resultados de las pruebas"
            echo "=========================================="
            echo ""
            echo "Tests ejecutados con Maestro Mobile Test"
            echo "Aplicación: Wikipedia Mobile"
            echo "Fecha: $(date)"
            echo ""

            # Si Maestro falló, obtener información adicional de debug
            if [ "$MAESTRO_EXIT_CODE" != "0" ]; then
              echo "=========================================="
              echo "DEBUG: Información de la pantalla actual (Maestro falló)"
              echo "=========================================="
              
              # Obtener información de la jerarquía de la UI actual
              echo ""
              echo "--- Jerarquía completa de la UI (uiautomator dump) ---"
              adb shell uiautomator dump /sdcard/ui_dump.xml
              adb pull /sdcard/ui_dump.xml ui_dump.xml 2>/dev/null || echo "No se pudo obtener dump de UI"
              if [ -f ui_dump.xml ]; then
                echo "Contenido del dump de UI:"
                cat ui_dump.xml | head -200
                echo ""
                echo "... (truncado, archivo completo guardado en ui_dump.xml)"
              fi
              
              echo ""
              echo "--- Información de ventanas activas (dumpsys window) ---"
              adb shell dumpsys window windows | grep -E "mCurrentFocus|mFocusedApp" | head -10 || echo "No se pudo obtener información de ventanas"
              
              echo ""
              echo "--- Elementos visibles en pantalla (texto) ---"
              adb shell uiautomator dump /dev/tty 2>/dev/null | grep -oP 'text="[^"]*"' | head -30 || echo "No se pudieron obtener elementos de texto"
              
              echo ""
              echo "--- Capturando screenshot manual del estado actual ---"
              SCREENSHOT_NAME="maestro-failure-$(date +%Y%m%d-%H%M%S).png"
              adb shell screencap -p /sdcard/screenshot.png
              adb pull /sdcard/screenshot.png "$SCREENSHOT_NAME" 2>/dev/null && echo "Screenshot guardado: $SCREENSHOT_NAME" || echo "No se pudo capturar screenshot"
              
              echo ""
              echo "--- Logs recientes de la aplicación ---"
              adb logcat -d -t 100 | grep -i "wikipedia\|error\|exception" | tail -50 || adb logcat -d | tail -30
              
              echo ""
              echo "--- Screenshots generados por Maestro ---"
              find . -name "*.png" -type f -mmin -5 | head -10 || echo "No se encontraron screenshots recientes de Maestro"
              
              echo ""
            fi

            if [ -f maestro-report.xml ]; then 
              echo "Reporte generado: maestro-report.xml"
              cat maestro-report.xml
            else 
              echo "No se generó reporte de Maestro"
            fi

            echo "=========================================="

            # Guardar screenshots y dumps en un directorio para artefactos
            mkdir -p maestro-screenshots
            find . -name "*.png" -type f -mmin -5 -exec cp {} maestro-screenshots/ \; || true
            find . -name "maestro-failure-*.png" -exec cp {} maestro-screenshots/ \; || true
            [ -f ui_dump.xml ] && cp ui_dump.xml maestro-screenshots/ || true

      - name: Subir screenshots como artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-screenshots
          path: maestro-screenshots/
          if-no-files-found: ignore
