name: Test Mobile Wikipedia con Maestro - iOS

on:
  workflow_dispatch:

jobs:
  ios-sim:
    runs-on: macos-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Instalar Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro --version

      - name: List available simulators
        run: xcrun simctl list devices

      - name: Boot iOS Simulator (iPhone 16)
        id: boot-simulator
        run: |
          UDID=$(xcrun simctl list devices available | grep -i "iPhone 16" | head -1 | grep -oE "[A-F0-9-]{36}")

          if [ -z "$UDID" ]; then echo "No se encontr贸 iPhone 16 disponible."; xcrun simctl list devices available; exit 1; fi

          echo "udid=$UDID" >> $GITHUB_OUTPUT

          xcrun simctl boot "$UDID" || true
          open -a Simulator
          echo "Simulador booted: $UDID"

      - name: Wait until simulator is ready
        run: |
          UDID="${{ steps.boot-simulator.outputs.udid }}"
          echo "Esperando simulador..."
          xcrun simctl bootstatus "$UDID" -b

      - name: Clonar app open-source de ejemplo
        run: |
          git clone https://github.com/appium/ios-uicatalog.git ios-app
          echo "Repositorio clonado en ios-app"
          ls -la ios-app/ | head -20

      - name: Compilar app para simulador
        id: compile-app
        run: |
          cd ios-app
          echo "Directorio actual: $(pwd)"
          echo "Contenido del directorio:"
          ls -la

          if [ ! -d "UICatalog.xcodeproj" ]; then
            echo "ERROR: UICatalog.xcodeproj no encontrado en $(pwd)"
            echo "Buscando archivos .xcodeproj..."
            find . -name "*.xcodeproj" -type d
            exit 1
          fi

          echo "Proyecto encontrado, iniciando compilaci贸n..."
          # Limpiar build anterior
          xcodebuild clean -project UICatalog.xcodeproj -scheme UICatalog -sdk iphonesimulator
          # Compilar para simulador
          xcodebuild -project UICatalog.xcodeproj -scheme UICatalog -sdk iphonesimulator -configuration Debug -derivedDataPath build
          # Guardar path del .app generado
          APP_PATH="$(pwd)/build/Build/Products/Debug-iphonesimulator/UICatalog.app"
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT

      - name: Instalar app en simulador
        run: |
          UDID="${{ steps.boot-simulator.outputs.udid }}"
          APP_PATH="${{ steps.compile-app.outputs.app_path }}"

          if [ ! -d "$APP_PATH" ]; then echo "ERROR: No se encontr贸 la app compilada en $APP_PATH"; exit 1; fi

          echo "Instalando app en el simulador..."
          xcrun simctl install "$UDID" "$APP_PATH"
          echo "App instalada"

      - name: Ejecutar tests con Maestro
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro test .maestro/wikipedia-ios.yaml --format junit --output maestro-report.xml || true

      - name: Mostrar reporte
        run: |
          if [ -f maestro-report.xml ]; then echo "=== Reporte generado ==="; cat maestro-report.xml; else echo "No se gener贸 reporte"; fi
